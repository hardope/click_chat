{% extends "layout.html" %}
{{ turbo() }}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
{% block body %}
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            let username = "{{username}}"
            var list;
            var newlist;
            let url = window.location.origin
            console.log(window.location.origin)

            let request = new XMLHttpRequest();
            request.open("GET", url + "/api/{{recipient}}");
            request.send();
            request.onload = () => {
                if (request.status === 200) {
                    let body = document.querySelector('#body');
                    list = JSON.parse(request.response);
                    newlist = list;
                    for (let obj of JSON.parse(request.response)) {
                        if (obj[0] === username ) {
                            var tag = document.createElement('h5');
                            tag.textContent = obj[2];
                            tag.setAttribute('style', 'text-indent: 85%;')
                            body.appendChild(tag);
                            var date = document.createElement('p');
                            date.textContent = obj[3];
                            date.setAttribute('style', 'text-indent: 85%;')
                            body.appendChild(date);
                        } else {
                            var tag = document.createElement('h5');
                            tag.textContent = obj[2];
                            body.appendChild(tag);
                            var date = document.createElement('p');
                            date.textContent = obj[3];
                            body.appendChild(date);
                        }
                    }
                }
            }
            function refresh() {
                let request = new XMLHttpRequest();
                request.open("GET", url + "/api/{{recipient}}");
                request.send();
                request.onload = () => {
                    if (request.status === 200) {
                        newlist = JSON.parse(request.response);
                        if (newlist.length > list.length){
                            var count = newlist.length - list.length;
                            for (let i = list.length -1; i < newlist.length-1; i++){
                                var tag = document.createElement('h5');
                                tag.textContent = newlist[i+1][2];
                                body.appendChild(tag);
                                var date = document.createElement('p');
                                date.textContent = newlist[i+1][3];
                                body.appendChild(date);
                            }
                            list = newlist;
                        }
                    }
                }
            }
            setInterval(refresh, 1000);
        });
    </script>
    <h3 style="text-indent: 50%;" id="recipient">{{ recipient }}</h3>
    <p style="text-indent: 80%;">Logged in as {{ username }}</p>
    <div id="body">
        
    </div>
    <form action="/message/{{ recipient }}" method="post">
        <div class="div">
            <input type="text" name="message" class="input" autocomplete="off" aria-autocomplete="none" autofocus>
            <input type="submit" value="Send">
        </div>
    </form>
{% endblock %}

